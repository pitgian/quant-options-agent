name: Fetch Options Data

on:
  # Trigger manuale per test
  workflow_dispatch:
    inputs:
      symbol:
        description: 'Symbol to fetch (SPY, QQQ, IWM, GLD, TLT, TV, ALL)'
        required: false
        default: 'TV'
      tv_only:
        description: 'Generate only TradingView JSON (lighter)'
        required: false
        type: boolean
        default: true
  
  # Scheduling automatico
  # Ogni ora dalle 14:30 alle 21:00 UTC (market hours US: 9:30 AM - 4:00 PM ET)
  schedule:
    # Ogni ora durante market hours (14:30, 15:30, ..., 20:30 UTC)
    - cron: '30 14-20 * * 1-5'  # Lun-Ven, 14:30-20:30 UTC

env:
  PYTHON_VERSION: '3.11'

jobs:
  fetch-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Necessario per commit
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt
      
      - name: Fetch options data
        id: fetch
        run: |
          # Costruisci il comando in base agli input
          SYMBOL="${{ github.event.inputs.symbol || 'TV' }}"
          TV_ONLY="${{ github.event.inputs.tv_only || 'true' }}"
          
          if [ "$TV_ONLY" = "true" ]; then
            python scripts/fetch_options_data.py \
              --symbol "$SYMBOL" \
              --tv-output data/tv_levels.json \
              --tv-only
          else
            python scripts/fetch_options_data.py \
              --symbol "$SYMBOL" \
              --output data/options_data.json \
              --tv-output data/tv_levels.json
          fi
        continue-on-error: false
      
      - name: Check for changes
        id: check_changes
        run: |
          # Controlla se ci sono cambiamenti in uno dei file
          CHANGED=false
          
          if [ -f data/options_data.json ]; then
            git diff --exit-code data/options_data.json || CHANGED=true
          fi
          
          if [ -f data/tv_levels.json ]; then
            git diff --exit-code data/tv_levels.json || CHANGED=true
          fi
          
          echo "changed=$CHANGED" >> $GITHUB_OUTPUT
      
      - name: Commit and push changes
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Aggiungi tutti i file dati modificati
          git add data/options_data.json 2>/dev/null || true
          git add data/tv_levels.json 2>/dev/null || true
          
          git commit -m "chore: update options data and TV levels [skip ci]"
          git push
      
      - name: Summary
        if: always()
        run: |
          echo "## Fetch Options Data Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Mostra info del file principale se esiste
          if [ -f data/options_data.json ]; then
            echo "### Full Options Data" >> $GITHUB_STEP_SUMMARY
            echo "✅ Generated at: $(jq -r '.generated' data/options_data.json)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Symbols:**" >> $GITHUB_STEP_SUMMARY
            jq -r '.symbols | keys[]' data/options_data.json >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Mostra info del file TradingView
          if [ -f data/tv_levels.json ]; then
            echo "### TradingView Levels" >> $GITHUB_STEP_SUMMARY
            echo "✅ Updated: $(jq -r '.updated' data/tv_levels.json)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Symbol | Spot | Gamma Flip | Call Walls | Put Walls |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|------|------------|------------|-----------|" >> $GITHUB_STEP_SUMMARY
            jq -r '.symbols | to_entries[] | "| \(.key) | \(.value.spot) | \(.value.gamma_flip) | \(.value.call_walls | join(", ")) | \(.value.put_walls | join(", ")) |"' data/tv_levels.json >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ ! -f data/options_data.json ] && [ ! -f data/tv_levels.json ]; then
            echo "❌ Failed to fetch data" >> $GITHUB_STEP_SUMMARY
          fi

  # Job opzionale per notifiche
  notify-on-failure:
    runs-on: ubuntu-latest
    needs: fetch-data
    if: failure()
    
    steps:
      - name: Create issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '⚠️ Options data fetch failed',
              body: 'The scheduled options data fetch workflow failed. Check the logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}',
              labels: ['automation', 'alert']
            })
